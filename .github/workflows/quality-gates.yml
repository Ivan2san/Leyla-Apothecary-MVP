name: Quality Gates

env:
  RUN_GOVERNANCE_HEAVY: 1

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  # Gate 1: Type Safety
  type-check:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run type check
        run: npm run type-check

  # Gate 2: Linting
  lint:
    name: ESLint Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

  # Gate 3: Tests (Once tests are written)
  test:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test --if-present || echo "No tests configured yet - add tests before Phase 4!"

      # Uncomment when tests are added:
      # - name: Check test coverage
      #   run: npm run test:coverage
      #   env:
      #     COVERAGE_THRESHOLD: 85

  # Gate 4: Build
  build:
    name: Production Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        env:
          # Use dummy env vars for build
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

  # Gate 5: Security Audit
  security:
    name: npm Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        run: npm audit --audit-level=moderate

      - name: Check for vulnerabilities
        run: |
          VULNERABILITIES=$(npm audit --json | jq '.metadata.vulnerabilities.total')
          if [ "$VULNERABILITIES" -gt 0 ]; then
            echo "‚ùå Found $VULNERABILITIES vulnerabilities!"
            echo "Run 'npm audit fix' to resolve them."
            exit 1
          fi
          echo "‚úÖ No vulnerabilities found!"

  # Gate 6: Lighthouse CI (Performance Budget)
  # Uncomment when ready to enforce performance
  # lighthouse:
  #   name: Lighthouse CI
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '18'
  #         cache: 'npm'
  #
  #     - name: Install dependencies
  #       run: npm ci
  #
  #     - name: Build project
  #       run: npm run build
  #       env:
  #         NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
  #         NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
  #
  #     - name: Run Lighthouse CI
  #       uses: treosh/lighthouse-ci-action@v10
  #       with:
  #         urls: |
  #           http://localhost:3000
  #           http://localhost:3000/products
  #           http://localhost:3000/checkout
  #         budgetPath: ./lighthouse-budget.json
  #         uploadArtifacts: true
  #         temporaryPublicStorage: true

  # Summary Check - All gates must pass
  all-gates-passed:
    name: All Quality Gates
    runs-on: ubuntu-latest
    needs: [type-check, lint, test, build, security]
    steps:
      - name: All gates passed
        run: |
          echo "‚úÖ All quality gates passed!"
          echo "‚úÖ Type checking: PASSED"
          echo "‚úÖ Linting: PASSED"
          echo "‚úÖ Tests: PASSED"
          echo "‚úÖ Build: PASSED"
          echo "‚úÖ Security: PASSED"
          echo ""
          echo "üöÄ Ready to merge!"
